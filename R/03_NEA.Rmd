---
title: "Network enrichment with NEArender"
output:
  html_notebook:
    code_folding: show
editor_options:
  chunk_output_type: console
---
# {.tabset .tabset-fade .tabset-pills}

## Setup
### Load libraries
```{r}
library(here)
library(tidyverse)
library(tidylog)
```

## Prepare AGS with Entrez ids
```{r}
## retrieve mapping
ags_ensg2entrez <- 
  all_degs_HPA$gene %>%
  AnnotationDbi::mapIds(keytype = "ENSEMBL",
                        column = "ENTREZID",
                        x = org.Hs.eg.db,
                        multiVals = "first") %>%
  enframe("ensg", "entrez_id") %>%
  filter(!duplicated(.$ensg))

n_distinct(all_degs_HPA$gene) # 730

## map the ids and construct the AGS object
ags_4vs2 <- all_degs_HPA %>%
  full_join(ags_ensg2entrez, by = c("gene" = "ensg")) %>%
  as.data.frame() %>%
  NEArender::import.gs(gs.type = "a", col.gene = 5, col.set = 1, Lowercase = F)
```

## Prepare FGS with Entrez ids
### Reactome 
```{r}
## download and clean Reactome gene:pathway file with Entrez ids
url = "https://reactome.org/download/current/NCBI2Reactome_All_Levels.txt"
file = here("data", "NCBI2Reactome_All_Levels.txt")

if(!file.exists(file)){
  download.file(url = url, destfile = file)
}

reactome71_entrez <- 
  read_tsv(file = file,
           col_names = c("entrezId", "reactomePathwayId", "url", "eventName", "evidenceCode", "species"),
           col_types = cols("entrezId" = col_character())) %>% 
  filter(species == "Homo sapiens") %>%
  unite("pathway", reactomePathwayId, eventName, sep = "_") %>%
  dplyr::select(entrezId, pathway)

n_distinct(reactome71_entrez$entrezId) # 10881
n_distinct(reactome71_entrez$pathway) # 2309

## create an FGS object
fgs_react71_entrez <- reactome71_entrez %>% 
  as.data.frame() %>%
  NEArender::import.gs(gs.type = "f", col.gene = 1, col.set = 2, Lowercase = F)

## Create a gmt file to use with Sumer's Affinity Propagation
react_gmt_3col <- reactome71_entrez %>%
  group_by(pathway) %>% 
  mutate(genes = str_c(entrezId, collapse = ",")) %>% 
  distinct(pathway, genes) %>% 
  separate(pathway, into = c("pathway_id", "pathway_name"), sep = "_", extra = "merge")
  
## Save the gmt file
react_gmt_3col %>%
  write_tsv(
    here("analysis", "full_gmts_entrez", "react_entrez_full.gmt"),
    na = "",
    col_names = F
)
```

### KEGG
```{r}
## Read and clean gmt file prepared by prepare_database function from geneSCF
## TODO: include the modified update_KEGG.sh script or rewrite it here 
kegg_gmt_3col <- read_tsv(here("data", "kegg_genescf_2020-01-08.gmt"),
                 col_names = c("pathway", "genes"),
                 col_types = cols(.default = "c")) %>% 
  separate(pathway, into = c("pathway_id", "pathway_name"), sep = "~") %>% 
  mutate(pathway_name = str_remove(pathway_name, fixed("_-_Homo_sapiens_(human)"))) %>% 
  mutate(pathway_name = str_replace_all(pathway_name, "_", " ")) 

nrow(kegg_gmt_3col) # 336 pathways

## Merge pathway ids with pathway names and cast the dataframe into a long format
kegg_long <- kegg_gmt_3col%>% 
  unite("pathway", pathway_id, pathway_name, sep = "_") %>% 
  splitstackshape::cSplit("genes", sep = ",", direction = "long", type.convert = F)

## Create an FGS object
fgs_kegg_entrez <- kegg_long %>%
  NEArender::import.gs(gs.type = "f", col.gene = 2, col.set = 1, Lowercase = F)

## Save the gmt file
kegg_gmt_3col %>% write_tsv(
  here("analysis", "full_gmts_entrez", "kegg_entrez_full.gmt"),
  na = "",
  col_names = F
)
```

### WikiPathways
```{r}
## download current gmt file from WP
file <- here("data", "wikipathways-20200110-gmt-Homo_sapiens.gmt")

if(!file.exists(file)){
  rWikiPathways::downloadPathwayArchive(organism = "Homo sapiens", format = "gmt", destpath = here("data"), date = "current") 
}

## clean the gmt file to contain 3 columns
wp_gmt_3col <- read_table(file, col_names = F) %>% 
  separate(X1, into = c("X1", "url", "genes"), sep = "\t", extra = "merge") %>% 
  separate(X1, into = c("pathway_name", "db_version", "pathway_id", "species"), sep = "%") %>% 
  dplyr::select(pathway_name, pathway_id, genes) %>% 
  mutate(genes = str_replace_all(genes, pattern = "\t", replacement = ","))

n_distinct(wp_gmt_3col$pathway_id) # 565

## Merge pathway ids with pathway names and cast the dataframe into a long format
wp_long <- wp_gmt_3col %>% 
  unite("pathway", pathway_id, pathway_name, sep = "_") %>% 
  splitstackshape::cSplit("genes", sep = "\t", direction = "long", type.convert = F)

## Create an FGS object
fgs_wp_entrez <- wp_long %>%
  NEArender::import.gs(gs.type = "f", col.set = 1, col.gene = 2, Lowercase = F)

## Create gmt file to use with Sumer
wp_gmt <- wp_gmt_3col %>% 
  splitstackshape::cSplit("genes", sep = "\t", direction = "wide", type.convert = F)

## Save the gmt file
wp_gmt %>% write_tsv(
  here("analysis", "full_gmts_entrez", "wp_entrez_full.gmt"),
  na = "",
  col_names = F
)
```
