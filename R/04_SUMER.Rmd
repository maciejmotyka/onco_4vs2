---
title: "Summarize enrichment results with SUMER"
output:
  html_notebook:
    code_folding: show
editor_options:
  chunk_output_type: console
---
# {.tabset .tabset-fade .tabset-pills}

# SUMER step 0 - prepare input files and configs
## Setup
### Load libraries and resolve conflicts
```{r}
library(here)
library(tidyverse)
library(tidylog)
library(conflicted)
conflict_prefer("select", "tidylog")
conflict_prefer("mutate", "tidylog")
conflict_prefer("left_join", "tidylog")
```

### Function definitions
#### Def makeFilesForSumer
```{r}
makeFilesForSumer <- function(df_list, outdir) {
  
  for (name in names(df_list)) {
    # create a gmt file
    df_list[[name]] %>% 
      select(pathway_name, pathway_id, "ags_genes" = starts_with("ags")) %>% 
      splitstackshape::cSplit("ags_genes", sep = ",") %>% 
      write_tsv(str_c(outdir, "/", name, ".gmt"), col_names = F, na = "")
    
    # create a score file
    df_list[[name]] %>% 
      select(pathway_name, fdr = starts_with("qval")) %>% 
      mutate(fdr = -log10(fdr)) %>% 
      # dplyr::mutate(fdr = round(fdr, digits = 3)) %>%
      write_tsv(str_c(outdir, "/", name, "_score.txt"), col_names = F)
  }
}
```

#### Def makeConfig4 (4 cancers)
```{r}
makeConfig4 <- function(project_name,
                        platform_type,
                        max_num_pathways = 50,
                        platform_abbr = "",
                        input_file_path, config_output_path) {
  
  list("project" = project_name,
       "top_num" = max_num_pathways,
       "data" = list(
         list(
         "platform_name" = platform_type[1],
         "platform_abbr" = platform_abbr[1],
         "gmt_file" = str_c(input_file_path, "/", platform_type[1], "_", project_name, ".gmt"),
         "score_file" = str_c(input_file_path, "/", platform_type[1], "_", project_name, "_score.txt")
         ),
         list(
         "platform_name" = platform_type[2],
         "platform_abbr" = platform_abbr[2],
         "gmt_file" = str_c(input_file_path, "/", platform_type[2], "_", project_name, ".gmt"),
         "score_file" = str_c(input_file_path, "/", platform_type[2], "_", project_name, "_score.txt")
         ),
         list(
         "platform_name" = platform_type[3],
         "platform_abbr" = platform_abbr[3],
         "gmt_file" = str_c(input_file_path, "/", platform_type[3], "_", project_name, ".gmt"),
         "score_file" = str_c(input_file_path, "/", platform_type[3], "_", project_name, "_score.txt")
         ),
         list(
         "platform_name" = platform_type[4],
         "platform_abbr" = platform_abbr[4],
         "gmt_file" = str_c(input_file_path, "/", platform_type[4], "_", project_name, ".gmt"),
         "score_file" = str_c(input_file_path, "/", platform_type[4], "_", project_name, "_score.txt")
         )
         )
       ) %>%
    jsonlite::toJSON(pretty = T, auto_unbox = T) %>%
    writeLines(str_c(config_output_path, "/", project_name, "_config.json"))
}
```

#### Def makeConfig3 (3 databases)
```{r}
makeConfig3 <- function(project_name,
                        platform_type,
                        max_num_pathways = 50,
                        platform_abbr = "",
                        input_file_path,
                        config_output_path) {
  
  list("project" = project_name,
       "top_num" = max_num_pathways,
       "data" = list(
         list(
         "platform_name" = platform_type[1],
         "platform_abbr" = platform_abbr[1],
         "gmt_file" = str_c(input_file_path, "/",project_name, "_", platform_type[1], ".gmt"),
         "score_file" = str_c(input_file_path, "/",project_name, "_", platform_type[1], "_score.txt")
         ),
         list(
         "platform_name" = platform_type[2],
         "platform_abbr" = platform_abbr[2],
         "gmt_file" = str_c(input_file_path, "/",project_name, "_", platform_type[2], ".gmt"),
         "score_file" = str_c(input_file_path, "/",project_name, "_", platform_type[2], "_score.txt")
         ),
         list(
         "platform_name" = platform_type[3],
         "platform_abbr" = platform_abbr[3],
         "gmt_file" = str_c(input_file_path, "/",project_name, "_", platform_type[3], ".gmt"),
         "score_file" = str_c(input_file_path, "/",project_name, "_", platform_type[3], "_score.txt")
         )
         )
       ) %>%
    jsonlite::toJSON(pretty = T, auto_unbox = T) %>%
    writeLines(str_c(config_output_path, "/", project_name, "_config.json"))
}
```

## Analysis
### Load NEArender results
```{r}
dir(here("analysis", "20200121-231554-NEArender_results"), full.names = T) %>% 
  map(load, .GlobalEnv)
```

### Prepare input files to Sumer
#### Create gmt and score files for Sumer
```{r} 
df_list <- Hmisc::llist(
  brca_kegg,
  brca_react,
  brca_wp,
  prad_kegg,
  prad_react,
  prad_wp,
  luad_kegg,
  luad_react,
  luad_wp,
  coadread_kegg,
  coadread_react,
  coadread_wp
)

makeFilesForSumer(df_list = df_list, outdir = here("analysis","SUMER"))
```

#### Create config files for Sumer
##### Per database
```{r}
makeConfig4(project_name = "kegg",
                   platform_type = c("brca", "prad", "luad", "coadread"),
                   max_num_pathways = ,
                   platform_abbr = c("b", "p", "l", "cr"),
                   input_file_path = here("analysis", "SUMER"), # looks for brca.gmt, brca_score.txt, prad.gmt, prad_score.txt, etc.
                   config_output_path = here("analysis", "SUMER", "configs"))

makeConfig4(project_name = "wp",
                   platform_type = c("brca", "prad", "luad", "coadread"),
                   max_num_pathways = ,
                   platform_abbr = c("b", "p", "l", "cr"),
                   input_file_path = here("analysis", "SUMER"),
                   config_output_path = here("analysis", "SUMER", "configs"))

makeConfig4(project_name = "react",
                   platform_type = c("brca", "prad", "luad", "coadread"),
                   max_num_pathways = ,
                   platform_abbr = c("b", "p", "l", "cr"),
                   input_file_path = here("analysis", "SUMER"),
                   config_output_path = here("analysis", "SUMER", "configs"))
```

##### Per cancer
```{r}
makeConfig3(project_name = "brca",
                   platform_type = c("kegg", "wp", "react"),
                   max_num_pathways = ,
                   platform_abbr = c("kg", "wp", "rct"),
                   input_file_path = here("analysis", "SUMER"),
                   config_output_path = here("analysis", "SUMER", "configs"))

makeConfig3(project_name = "prad",
                   platform_type = c("kegg", "wp", "react"),
                   max_num_pathways = ,
                   platform_abbr = c("kg", "wp", "rct"),
                   input_file_path = here("analysis", "SUMER"),
                   config_output_path = here("analysis", "SUMER", "configs"))

makeConfig3(project_name = "luad",
                   platform_type = c("kegg", "wp", "react"),
                   max_num_pathways = ,
                   platform_abbr = c("kg", "wp", "rct"),
                   input_file_path = here("analysis", "SUMER"),
                   config_output_path = here("analysis", "SUMER", "configs"))

makeConfig3(project_name = "coadread",
                   platform_type = c("kegg", "wp", "react"),
                   max_num_pathways = ,
                   platform_abbr = c("kg", "wp", "rct"),
                   input_file_path = here("analysis", "SUMER"),
                   config_output_path = here("analysis", "SUMER", "configs"))
```

### Make gmt files for 2 step of Sumer
#### Define function for making gmt files
```{r}
makeFullGmt <- function(ags, gmt, outfile){
  left_join(ags, gmt, by = c("pathway_id", "pathway_name")) %>%
  select(pathway_name, pathway_id, genes) %>%
  # splitstackshape::cSplit("genes") %>%
  write_tsv(here("analysis", "full_gmts", outfile), na = "", col_names = F)
}
```

#### Make gmt files
```{r}
makeFullGmt(prad_kegg, kegg_gmt_3col, outfile = "prad-kegg.gmt")
makeFullGmt(prad_react, react_gmt_3col, "prad-react.gmt")
makeFullGmt(prad_wp, wp_gmt_3col, "prad-wp.gmt")

makeFullGmt(luad_kegg, kegg_gmt_3col, outfile = "luad-kegg.gmt")
makeFullGmt(luad_react, react_gmt_3col, "luad-react.gmt")
makeFullGmt(luad_wp, wp_gmt_3col, "luad-wp.gmt")

makeFullGmt(brca_kegg, kegg_gmt_3col, outfile = "brca-kegg.gmt")
makeFullGmt(brca_react, react_gmt_3col, "brca-react.gmt")
makeFullGmt(brca_wp, wp_gmt_3col, "brca-wp.gmt")

makeFullGmt(coadread_kegg, kegg_gmt_3col, outfile = "coadread-kegg.gmt")
makeFullGmt(coadread_react, react_gmt_3col, "coadread-react.gmt")
makeFullGmt(coadread_wp, wp_gmt_3col, "coadread-wp.gmt")
```

# SUMER step 1 - Weighted Set Cover
```{r}
# source scripts needed by sumer step 1
source(here("R/sumerWeightedSetCover.R"))
  # my own version; defines: sumerWeightedSetCover, check_config and gmt2list
source(here("R/topGeneSets.R"))# defines: uuid.gen and topGeneSets
source(here("R/weightedSetCover.R")) # defines: topSCGeneSets


projects <- c("kegg", "wp", "react", "brca", "coadread", "luad", "prad")
configs <- list()
for (project in projects) {
  configs[project] <- here("analysis", "SUMER", "configs", paste0(project, "_config.json"))
}

output_dirs <- list()
for (project in projects) {
  output_dirs[project] <- here("output", "SUMER", project)
}


```

